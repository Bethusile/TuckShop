"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.deleteCategory = exports.updateCategory = exports.createCategory = exports.fetchCategoryById = exports.fetchAllCategories = void 0;
// server/src/services/categoryService.ts
const knex_1 = __importDefault(require("../knex"));
// --- Service Logic ---
// 1. READ ALL Categories
const fetchAllCategories = async () => {
    return (0, knex_1.default)('category').select('*').orderBy('name', 'asc');
};
exports.fetchAllCategories = fetchAllCategories;
// 2. READ ONE Category
const fetchCategoryById = async (categoryid) => {
    return (0, knex_1.default)('category').select('*').where({ categoryid }).first();
};
exports.fetchCategoryById = fetchCategoryById;
// 3. CREATE Category
const createCategory = async (name) => {
    // Note: The categoryid is auto-generated by PostgreSQL SERIAL
    const [newCategory] = await (0, knex_1.default)('category')
        .insert({ name })
        .returning('*');
    // Knex's returning behavior can sometimes return an array even for a single insert
    return newCategory;
};
exports.createCategory = createCategory;
// 4. UPDATE Category
const updateCategory = async (categoryid, name) => {
    // Returns the number of rows affected (0 or 1)
    return (0, knex_1.default)('category')
        .where({ categoryid })
        .update({ name });
};
exports.updateCategory = updateCategory;
// 5. DELETE Category
const deleteCategory = async (categoryid) => {
    // First, check if there are any products associated with this category
    const productsCount = await (0, knex_1.default)('product')
        .where({ categoryid })
        .count('itemid as count')
        .first();
    const count = productsCount ? Number(productsCount.count) : 0;
    if (count > 0) {
        throw new Error(`Cannot delete category. ${count} product(s) are still associated with this category.`);
    }
    // If no products are associated, proceed with deletion
    return (0, knex_1.default)('category').where({ categoryid }).del();
};
exports.deleteCategory = deleteCategory;
//# sourceMappingURL=categoryService.js.map